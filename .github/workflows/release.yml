name: Publish Release

on:
  push:
    tags:
      - 'v*' # Triggers when you push a tag like 'v1.0.0'

permissions:
  contents: write # Required to create the GitHub Release and upload files

jobs:
  publish:
    name: Package and Release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux dependencies (FLTK & Packaging)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxext-dev libxft-dev libxinerama-dev libxcursor-dev libxrender-dev libxfixes-dev libpango1.0-dev libgl1-mesa-dev libglu1-mesa-dev fakeroot dpkg rpm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}

      - name: Install cargo-packager
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-packager

      - name: Build Executable
        run: cargo build -p app --release

      - name: Build and Package Application
        # Because you are in a workspace, we use `-p app` to target your executable crate
        run: cargo packager -p app --release

      - name: Upload Installers to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # This grabs the output directory we defined in your crates/app/Cargo.toml
          files: target/release/installers/**/*
          draft: true # Creates a draft release so you can edit the patch notes before publishing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
